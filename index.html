<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Restful.io by mvallerie</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Restful.io</h1>
        <p>Restful-like routing module for NodeJS and socket.io</p>

        <p class="view"><a href="https://github.com/mvallerie/restful.io">View the Project on GitHub <small>mvallerie/restful.io</small></a></p>


        <ul>
          <li><a href="https://github.com/mvallerie/restful.io/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/mvallerie/restful.io/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/mvallerie/restful.io">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a name="restfulio" class="anchor" href="#restfulio"><span class="octicon octicon-link"></span></a>restful.io</h1>

<p>restful.io has been designed to develop quickly a realtime routing system for your "RESTful-like" apps. It's using <a href="https://github.com/Automattic/socket.io">socket.io</a> but the module does not depend on it</p>

<h2>
<a name="inspirations" class="anchor" href="#inspirations"><span class="octicon octicon-link"></span></a>Inspirations</h2>

<ul>
<li><a href="https://github.com/playframework/playframework">Play Framework 2</a></li>
<li><a href="https://github.com/techpines/express.io">Express.io</a></li>
<li>RESTful architectures</li>
</ul><h2>
<a name="installation" class="anchor" href="#installation"><span class="octicon octicon-link"></span></a>Installation</h2>

<p><code>npm install --save restful.io</code></p>

<h2>
<a name="overview" class="anchor" href="#overview"><span class="octicon octicon-link"></span></a>Overview</h2>

<p>Below is a quick presentation of the module. You may check examples subdir for more.</p>

<h2>
<a name="server-side" class="anchor" href="#server-side"><span class="octicon octicon-link"></span></a>Server-side</h2>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http'</span><span class="p">).</span><span class="nx">Server</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"socket.io"</span><span class="p">)(</span><span class="nx">http</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">RestfulRouter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"restful.io"</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">FooController</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">bar</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"FooController.bar("</span><span class="o">+</span><span class="nx">param</span><span class="o">+</span><span class="s2">");"</span><span class="p">);</span>
    <span class="k">return</span> <span class="s2">"OK"</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">barJson</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">jsonParam</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"FooController.barJson("</span><span class="o">+</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">jsonParam</span><span class="p">)</span><span class="o">+</span><span class="s2">");"</span><span class="p">);</span>
    <span class="k">return</span> <span class="s2">"OK"</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// This ugly stuff is actually used to have a way to link route string and JS object</span>
<span class="kd">var</span> <span class="nx">ControllerScope</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">"FooController"</span><span class="o">:</span> <span class="nx">FooController</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RestfulRouter</span><span class="p">(</span><span class="nx">ControllerScope</span><span class="p">,</span> <span class="p">{</span>
  <span class="c1">// These are method names, feel free to change or to add</span>
  <span class="c1">// Here I used GET/PUT/DELETE only to mimic classic RESTful app</span>
  <span class="nx">GET</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="c1">// p:varname indicates a primitive type parameter</span>
      <span class="c1">// Parameter names are bound between uri and route handler</span>
      <span class="nx">uri</span><span class="o">:</span> <span class="s2">"/foo/p:param"</span><span class="p">,</span>
      <span class="nx">to</span><span class="o">:</span> <span class="s2">"FooController.bar(param)"</span>
    <span class="p">}</span>
    <span class="c1">// You can add as many more routes as you wish</span>
  <span class="p">],</span>
  <span class="nx">PUT</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="c1">// j:varname indicates a JSON object parameter</span>
      <span class="nx">uri</span><span class="o">:</span> <span class="s2">"/foo/j:param"</span><span class="p">,</span>
      <span class="nx">to</span><span class="o">:</span> <span class="s2">"FooController.barJson(param)"</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="nx">POST</span><span class="o">:</span> <span class="p">[</span>
    <span class="c1">// No route yet</span>
  <span class="p">],</span>
  <span class="nx">DELETE</span><span class="o">:</span> <span class="p">[</span>
    <span class="c1">// No route yet</span>
  <span class="p">],</span>
  <span class="c1">// Nested methods are supported</span>
  <span class="nx">FOO</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">BAR</span><span class="o">:</span> <span class="p">[</span>
      <span class="c1">// Here, the method will be FOO:BAR (: is the default separator)</span>
      <span class="c1">// No route yet</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">},</span> <span class="kc">true</span><span class="p">);</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">io</span><span class="p">);</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8080</span><span class="p">);</span>
</pre></div>

<h2>
<a name="client-side" class="anchor" href="#client-side"><span class="octicon octicon-link"></span></a>Client-side</h2>

<p>You have two ways to deal with the client side.</p>

<h3>
<a name="client-api" class="anchor" href="#client-api"><span class="octicon octicon-link"></span></a>Client API</h3>

<p>This is the preferred way. The second parameter of start method is a boolean. Set it to true on the server side as below :</p>

<div class="highlight highlight-javascript"><pre><span class="nx">router</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</pre></div>

<p>Now on the client side, you can make a GET on /api to retrieve the code :</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">(</span><span class="s1">'http://localhost:8080'</span><span class="p">);</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'connect'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Here we wait for API</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'GET:RESULT'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">apiSrc</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// You get JS code to eval</span>
    <span class="kd">var</span> <span class="nx">API</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nx">apiSrc</span><span class="p">)(</span><span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Get foo 1</span>
    <span class="nx">API</span><span class="p">.</span><span class="nx">GET</span><span class="p">(</span><span class="s2">"/foo/1"</span><span class="p">,</span> <span class="p">{},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Result GET : "</span> <span class="o">+</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">API</span><span class="p">.</span><span class="nx">PUT</span><span class="p">(</span><span class="s2">"/foo/j:user"</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">user</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">name</span><span class="o">:</span> <span class="s2">"John Smith"</span><span class="p">,</span>
        <span class="nx">age</span><span class="o">:</span> <span class="mi">42</span>
      <span class="p">}</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Result PUT : "</span> <span class="o">+</span> <span class="nx">user</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="c1">// Asking for API</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'/api'</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p>By default, API's code is automagically generated using your routes. For nested methods, use subobjects :</p>

<div class="highlight highlight-javascript"><pre><span class="nx">API</span><span class="p">.</span><span class="nx">FOO</span><span class="p">.</span><span class="nx">BAR</span><span class="p">;</span> <span class="c1">// Corresponds to nested method BAR inside FOO</span>
</pre></div>

<p>Please note that every autogenerated function in API has the same signature :</p>

<div class="highlight highlight-javascript"><pre><span class="nx">API</span><span class="p">.</span><span class="nx">YOUR_METHOD</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">jsonParams</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>
</pre></div>

<h5>
<a name="extending-api" class="anchor" href="#extending-api"><span class="octicon octicon-link"></span></a>Extending API</h5>

<p>If you need to expose to client more API methods than autogenerated ones, just provide an APIController inside router context and create a method inside with the following signature :</p>

<div class="highlight highlight-javascript"><pre><span class="kd">function</span> <span class="nx">get</span><span class="p">(</span><span class="nx">API</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Do your stuff and add your custom methods here</span>
  <span class="c1">// Remember that API code is sent WITHOUT the context, so never use variables which doesn't live in API context.</span>
  <span class="k">return</span> <span class="nx">API</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<h3>
<a name="raw-javascript" class="anchor" href="#raw-javascript"><span class="octicon octicon-link"></span></a>Raw Javascript</h3>

<p>This method is dangerous. Because socket.io is asynchronous by nature, you can only have several handlers listening on the same event.</p>

<p>In restful.io, each request is associated with a unique ID. If you use raw Javascript, you will have to handle these identifiers manually.</p>

<p>Remember that if you don't provide any unique ID to socket.emit, other handlers might intercept your request's response too, which may end on unpredictable behaviours.</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'socket.io-client'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">(</span><span class="s1">'http://localhost:8080'</span><span class="p">);</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'connect'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// For primitive parameters, you can pass it directly in the URI</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'/foo/4'</span><span class="p">);</span>

  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'GET:RESULT'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Result GET : "</span> <span class="o">+</span> <span class="nx">data</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="c1">// For complex JSON parameter, you have to send a plain JSON object corresponding the format below</span>
  <span class="c1">// The name of your parameter is used to retrieve the value</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'PUT'</span><span class="p">,</span> <span class="p">{</span>
    <span class="c1">// Here we provide a requestId</span>
    <span class="nx">requestId</span><span class="o">:</span> <span class="s1">'REQUEST_1'</span>
    <span class="nx">uri</span><span class="o">:</span> <span class="s1">'/foo/j:user'</span><span class="p">,</span>
    <span class="nx">json</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">user</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">name</span><span class="o">:</span> <span class="s2">"John Smith"</span><span class="p">,</span>
        <span class="nx">age</span><span class="o">:</span> <span class="mi">42</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="c1">// We have to listen on PUT:requestId and not on PUT:RESULT</span>
  <span class="c1">// Actually, RESULT is the default requestId</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'PUT:REQUEST_1'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Result PUT : "</span> <span class="o">+</span> <span class="nx">data</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>

<h2>
<a name="and-more" class="anchor" href="#and-more"><span class="octicon octicon-link"></span></a>And more</h2>

<p>Here is described the usable parameters when constructing a router :</p>

<table>
<thead><tr>
<th>Name</th>
<th>Type</th>
<th>Defaults</th>
<th>Example</th>
</tr></thead>
<tbody>
<tr>
<td>ctx</td>
<td>JSON</td>
<td>NA</td>
<td>{ "FooController": FooController, "BarController": BarController }</td>
</tr>
<tr>
<td>routes</td>
<td>JSON</td>
<td>NA</td>
<td>Main JSON config. See snippet before</td>
</tr>
<tr>
<td>verbose</td>
<td>boolean</td>
<td>false</td>
<td>If true, much more log will appear</td>
</tr>
<tr>
<td>methodSeparator</td>
<td>character</td>
<td>':'</td>
<td>Used for nested methods.</td>
</tr>
<tr>
<td>uriSeparator</td>
<td>character</td>
<td>'/'</td>
<td>Used to parse URIs.</td>
</tr>
<tr>
<td>parameterPrefix</td>
<td>string</td>
<td>"p:"</td>
<td>Used to identify primitive parameter.</td>
</tr>
<tr>
<td>jsonParameterPrefix</td>
<td>string</td>
<td>"j:"</td>
<td>Used to identify complex JSON parameter.</td>
</tr>
<tr>
<td>resultSuffix</td>
<td>string</td>
<td>"RESULT"</td>
<td>Default requestId fired to client if requestId not provided (GET:RESULT, POST:RESULT, ...)</td>
</tr>
</tbody>
</table><p>When you start the router, as a third parameter, you may use a callback to handle user connection :</p>

<div class="highlight highlight-javascript"><pre><span class="nx">router</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"User connected on : "</span> <span class="o">+</span> <span class="nx">socket</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<h2>
<a name="warranty" class="anchor" href="#warranty"><span class="octicon octicon-link"></span></a>Warranty</h2>

<p>restful.io is currently under heavy development. I'm building this project for myself and i try to make the code as clean as possible (which is far away from now :)). Feel free to submit a PR. Same for this README.</p>

<h4>
<a name="known-limitations" class="anchor" href="#known-limitations"><span class="octicon octicon-link"></span></a>Known limitations</h4>

<ul>
<li>Route parsing is poor and must be rewritten</li>
<li>Error handling is very approximative</li>
<li>socket.io only</li>
</ul><h4>
<a name="currently-working-on" class="anchor" href="#currently-working-on"><span class="octicon octicon-link"></span></a>Currently working on</h4>

<ul>
<li>Known limitations</li>
<li>Better parameters model</li>
<li>File support</li>
<li>Get rid of the context object</li>
</ul><h4>
<a name="ideas-for-later" class="anchor" href="#ideas-for-later"><span class="octicon octicon-link"></span></a>Ideas for later</h4>

<ul>
<li>Get rid of socket.io to use raw Websockets ?</li>
<li>Client module ?</li>
</ul>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/mvallerie">mvallerie</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>